{{Header}}
{{title|title=
Onionizing Repositories
}}
{{#seo:
|description=The guide explains how to configure Tor onion services for APT repositories to enhance security and privacy, but it may cause system updates to fail due to unreliability. The configuration provides protection against targeted and man-in-the-middle attacks, and prevents tracking of installed programs.
|image=Onionrepository23234.jpg
}}
[[File:Onionrepository23234.jpg|thumb]]
{{intro|
The guide explains how to configure experimental Tor onion services for APT repositories. The configuration provides additional security and privacy benefits, such as protection against targeted attacks, man-in-the-middle attacks, and preventing tracking of installed programs, but it may cause system updates to fail due to unreliability.

Note: This page applies to Kicksecure. Kicksecure is not a torifying proxy; this configuration only affects APT repository downloads and does not automatically onionize or torify other system traffic.
}}

= Introduction =

When software packages from Debian, {{project_name_long}}, Fedora, Qubes (and others) are downloaded prior to the installation of new packages or upgrades, the package repository sources default to the https transport protocol, which is [[SSL|non-ideal for security]]. Instead, experimental Tor onion services can be configured for a number of platforms, which provides several security and privacy benefits: <ref>https://blog.torproject.org/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates -- attackers are forced to attack everyone requesting the update.
* The package repository, or observers watching it, cannot track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks, like version downgrade attacks.

Be aware that enabling onion repositories may cause system updates to periodically fail due to their [https://forums.whonix.org/t/disable-onions-by-default-due-to-unreliability/6650 unreliability]. If this becomes an issue, it is encouraged to [[Operating_System_Software_and_Updates#Non-functional_Onion_Services|Re-enable Clearnet Repositories]] so packages can be updated.

If the term "comment" is unfamiliar, please follow [https://www.howtogeek.com/118389/how-to-comment-out-and-uncomment-lines-in-a-configuration-file/ this link] to learn how to comment / uncomment lines in a configuration file.

= Onionize Debian Package Sources =

{{Box|text=
{{IconSet|h1|1}} {{Open with root rights|filename=
/etc/apt/sources.list.d/debian.sources
}} <!-- /Open with root rights -->

{{IconSet|h1|2}} Enable the onionized Debian repositories and disable the clearnet repositories.

Enable the following .onion mirrors and disable the corresponding https repositories (except the fasttrack repository).

{{CodeSelect|code=
######## ENABLED SOURCES ########

Types: deb
URIs: tor+https://deb.debian.org/debian
Suites: trixie trixie-updates trixie-backports
Components: main contrib non-free non-free-firmware
Enabled: no                     # <<<<< change this line from "yes" to "no"
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

Types: deb
URIs: tor+https://deb.debian.org/debian-security
Suites: trixie-security
Components: main contrib non-free non-free-firmware
Enabled: no                     # <<<<< change this line from "yes" to "no"
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

Types: deb
URIs: tor+https://fasttrack.debian.net/debian-fasttrack
Suites: trixie-fasttrack trixie-backports-staging
Components: main contrib non-free
Enabled: yes                    # <<<<< keep this line saying "yes"
Signed-By: /usr/share/keyrings/fasttrack-archive-keyring.gpg

######## DISABLED BY DEFAULT SOURCES ########

#### deb ####

Types: deb
URIs: tor+http://2s4yqjx5ul6okpp3f2gaunr2syex5jgbfpfvhxxbbjwnrsvbk5v3qbid.onion/debian
Suites: trixie trixie-updates trixie-backports
Components: main contrib non-free non-free-firmware
Enabled: yes                    # <<<<< change this line from "no" to "yes"
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

Types: deb
URIs: tor+http://5ajw6aqf3ep7sijnscdzw77t7xq4xjpsy335yb2wiwgouo7yfxtjlmid.onion/debian-security
Suites: trixie-security
Components: main contrib non-free non-free-firmware
Enabled: yes                    # <<<<< change this line from "no" to "yes"
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

## No onion for fasttrack yet: https://salsa.debian.org/fasttrack-team/support/-/issues/27
}} <!-- /CodeSelect -->

{{IconSet|h1|3}} Save and exit.
}} <!-- /Box -->

= Onionize {{project_name_short}} APT Sources =

Follow these steps to point the {{project_name_short}} <code>sources</code> file to the onion mirror. See [[Project-APT-Repository|{{project_name_short}} APT Repository overview]] for details on the four repository choices.

This can be done using <code>repository-dist</code> {{cli}} tool with the <code>--transport onion</code> option.

{{Box|text=
{{IconSet|h1|1}} Run the following command:

{{CodeSelect|code=
sudo repository-dist --enable --transport onion
}} <!-- /CodeSelect -->

{{IconSet|h1|2}} Confirm the onionized repository is functional.

{{CodeSelect|code=
upgrade-nonroot
}} <!-- /CodeSelect -->
}} <!-- /Box -->

= Onionize Tor Project APT Sources =

For enhanced security, advanced users and testers can onionize Tor Project updates; see [[Tor_Versioning|Tor Versioning]] for further details.

= Qubes =

* <u>Limitation:</u> Kicksecure cannot be used as a torifying proxy for Qubes <code>dom0</code> or for other templates (for example Debian or Fedora TemplateVM updates). For this use case, use [[Whonix]] and see also {{whonix_wiki
|wikipage=Onionizing_Repositories
|text=Whonix wiki page Onionizing Repositories
}} <!-- close Template:whonix_wiki -->
* <u>Related Qubes upstream issues:</u> Qubes onion APT repository issues:
** <u>dom0 updater behavior / unreachable repos:</u> [https://forum.qubes-os.org/t/qubes-dom0-update-fails-to-detect-release-version-on-all-operations/6729/16 Qubes dom0 update fails to detect release version]
** <u>Template repo content / template confusion:</u> [https://forum.qubes-os.org/t/onion-mirror-for-qubes-templates-itl-not-serving-debian-13-even-though-present-was-qvm-template-confusion/37358 Onion mirror for Qubes templates: Debian 13 not served]
** <u>Note:</u> Qubes onion APT repository issues are [[unspecific|unspecific to {{project_name_short}}]]

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]