{{Header}} __FORCETOC__
{{title|title=
Recovery
}}
{{#seo:
|description=Recovery Mode, Emergency, Chroot, Debugging, Capturing Diagnostic Output from Serial Console
|image=Recovery312123.jpg
}}
{{troubleshooting_mininav}}
[[File:Recovery312123.jpg|thumb]]
{{intro|
The goal of this wiki page is to provide the user with knowledge for higher system reliability, robustness, increased uptime, backup, restoration, recovery and repair skills.
}}
= Introduction =
It is prudent to acquire system recovery skills prior to an eventual later grave issue such as an unbootable VM or even unbootable host operating system, data loss or similar. This is because naturally for most users once they are affected by a grave issue, the mind goes into "issue solving mode", which can be stressful and less productive, specifically when it is currently a bad time to acquire these skills due to other more pressing priorities. By learning these skills in advance, one can obtain the skills during a more appropriate time in a much more positive, relaxed environment which might potentially greatly increase a user's ability and lower the time required to fix their broken system, should this happen in the future.

= Useful Skills =

* Boot an {{os}} from an external USB / DVD boot drive.
* Boot an {{os}} from an external USB / DVD boot drive and mount the OS which is installed on the internal hard drive to access or backup its data. <ref>
For Qubes, see: https://www.qubes-os.org/doc/mount-from-other-os/
</ref> Yes, this is also possible when using [[Full Disk Encryption]].
* Remove an internal drive from one computer, move it into a USB enclosure and access its data from a different computer.
* [[Grub#Kernel_Boot_Parameter_Change|Temporary Kernel Boot Parameter Change]] using [[grub]] bootloader boot menu.
* [[Grub#Permanent_Configuration_Changes|Permanent Kernel Boot Parameter Configuration Changes]].
* [[Grub#Inspect_Grub_Configuration_Changes|Inspect Grub Configuration Changes]].
* [[Raw Disk Backup|Raw Disk Backup and Restoration]].
* [[Recovery#Recovery_Mode|How to boot into recovery mode]].
* How to switch to a [[Desktop#Virtual_Consoles|virtual console]] in a {{VM}}.
* How to switch to a virtual console on the host operating system.
* [[Troubleshooting#Enable_Persistent_Systemd_Journal_Log|Enable Persistent Systemd Journal Log]]
* [[Troubleshooting#Check_Systemd_Journal_Log_of_Previous_Boot|Check Systemd Journal Log of Previous Boot]]
* [[Troubleshooting#Check_Systemd_Journal_Log_of_Failed_Boot|Check Systemd Journal Log of Failed Boot]]
* hard drive health check (S.M.A.R.T)
* Topics mentioned on the [[Troubleshooting]] wiki page.
* Other topics mentioned on this wiki page.

= Useful Habits =
* Keep the log of any [[Operating System Software and Updates|system upgrades]] as well as [[Install Software|software installation]] processes.
* Keep one or multiple root virtual terminal tabs in a terminal emulator open during actions which might result in an unbootable system, data loss, inability to access the root account, or other issues during software installation or upgrades. The same goes for one or multiple root [[Desktop#Virtual_Consoles|virtual consoles]]. This advice (for higher ability to easily recover from issues when gaining root) conflicts with the [[Root#General_Security_Advice|general security advice]] from the [[root]] wiki page (for better security).

= Recovery Mode =

If an error occurs that prevents {{project_name_long}} from booting, it is possible to try and boot {{project_name_long}} into either:

* {{IconSet|h2|A}} Linux '''recovery mode''' (sometimes called <code>Single User Mode</code>) to fix the problem.; or
* {{IconSet|h2|B}} Use a dracut emergency shell.

This is possible in many cases but not, for example, if [[grub|GRUB]] is broken.

It is advisable to learn how to use recovery mode while everything is still functional in case of future issues.

See also [[root]] wiki page, specifically chapters:

* [[Root#Recovery_Mode|Root Login using Recovery Mode]]
* [[Root#Passwordless_Recovery_Mode_Security_Discussion|Passwordless Recovery Mode Security Discussion]]

{| class="wikitable"
|+ ''Recovery mode and dracut emergency shell - kernel parameters''

! Kernel Parameter
! {{project_name_short}} Default Setting
! Useful Action for Kernel Parameter
! Effect of Action
|-

| <code>single</code>
| No
| Add
| Boots into Linux recovery mode (single-user mode), useful for maintenance or troubleshooting.
|-

| <code>loglevel=0</code>
| Yes
| Remove
| Allows kernel to print messages with the default log level, making boot output more verbose.
|-

| <code>quiet</code>
| Yes
| Remove
| Disables suppression of boot messages; more details are displayed during boot.
|-

| <code>rd.shell=0</code>
| Yes
| Remove
| Re-enables the emergency shell in case of boot failure.
|-

| <code>rd.emergency=halt</code>
| Yes
| Remove
| Prevents system from halting on an emergency and instead drops to dracut’s default emergency shell.
|-

| <code>SYSTEMD_SULOGIN_FORCE=1</code>
| No
| Add
| Allows root login in dracut recovery shell
|-

| <code>rd.debug</code>
| No
| Add
| Enable dracut verbose output.
|-

| <code>rd.break=premount</code>
| No
| Add
| Drop to dracut recovery shell prior mounting system disk for example for the purpose of manually running <code>fsck</code>.
|-

|}

Choose an option.

{{Tab
|type=controller
|content=

{{Tab
|title= == Kernel Boot Parameter Single ==
|type=section
|image=
|addToClass=info-box
|active=
|content=
{{IconSet|h1|1}} Choose from above table. Any adding and/or removing of any kernel parameter is optional.

{{IconSet|h1|2}} Removing the kernel parameters <code>loglevel=0</code> <code>quiet</code> <code>rd.shell=0</code> <code>rd.emergency=halt</code> can be very useful for debugging.

{{IconSet|h1|3}} Adding <code>single</code> activates Linux recovery mode.

{{IconSet|h1|4}} Follow the [[Grub#Kernel_Boot_Parameter_Change|Temporary Kernel Boot Parameter Change]] instructions to change the kernel parameters for a single boot.

{{IconSet|h1|5}} Done.

Kernel parameters have been selected and adjusted for a single boot.
}}

{{Tab
|title= == Linux recovery mode boot entry ==
|type=section
|image=
|addToClass=info-box
|active=
|content=
{{IconSet|h1|1}} [https://forums.kicksecure.com/t/remove-linux-recovery-mode-boot-option-from-default-grub-boot-menu/727 Linux recovery mode boot option has been removed from default GRUB boot menu for security and usability reasons].

{{IconSet|h1|2}} To restore the Linux recovery mode boot entry and re-enable dracut emergency shell, one option would be to delete the [https://github.com/Kicksecure/security-misc/blob/master/etc/default/grub.d/41_recovery_restrict.cfg <code>/etc/default/grub.d/41_recovery_restrict.cfg</code>] configuration file. This is of course only possible if the system is still booting (or more complicated, using a chroot). Delete the file responsible for Linux recovery mode disabling: {{CodeSelect|code=
sudo safe-rm -- /etc/default/grub.d/41_recovery_restrict.cfg
}}

{{IconSet|h1|3}} Update [[Grub|GRUB]] boot menu: {{CodeSelect|code=
sudo update-grub
}}

{{IconSet|h1|4}} After powering on {{project_name_short}}, you will see the virtual BIOS for a second, then the grub boot menu. The grub boot menu is easily identified by the first line of text which begins with either <code>GNU GRUB</code> or <code>Choose boot mode</code>.

{{IconSet|h1|5}} Use the arrow keys to navigate and select <code>Advanced Options for {{project_name_short}} GNU/Linux</code>.

{{IconSet|h1|6}} Press <code>Enter</code>.

{{IconSet|h1|7}} Choose the second option which at the end displays <code>(recovery mode)</code>.

{{IconSet|h1|8}} Press <code>Enter</code>.

{{IconSet|h1|9}} Somewhere in the output, a message similar to the following will appear (it might be interleaved with other debug output): <blockquote>Give root password for maintenance (Or press control + d to continue):</blockquote>

{{IconSet|h1|10}} Enter the root password.

{{IconSet|h1|11}} While typing, no asterisk symbols (<code>*</code>) will appear; the password must be typed "blind". <ref>
See also: [[Default_Passwords|Default Passwords]].
</ref>

{{IconSet|h1|12}} Press <code>Enter</code>.

{{IconSet|h1|13}} The default keyboard layout will be <code>en-US</code>. To change this setting, see: [[Keyboard Layout]].

{{IconSet|h1|14}} Type <code>exit</code> to continue booting, or <code>poweroff</code> or <code>reboot</code> to shut down or reboot the system.

{{IconSet|h1|15}} Done.

Linux recovery mode boot entry has been used to access maintenance mode.
}}
}}

TODO: Explore whether networking is possible and how to transfer files out of the VM.

= Emergency Recovery Console =
Also initramfs-tools users sometimes call this initramfs shell, initramfs prompt or emergency recovery console.

== Dracut Emergency Shell ==

[[dracut]] [https://forums.kicksecure.com/t/harden-dracut-initramfs-generator-by-disabling-recovery-console/724 emergency shell is disabled by default in {{project_name_short}} for security reasons.] This is implemented in file [https://github.com/{{project_name_short}}/security-misc/blob/master/etc/default/grub.d/41_recovery_restrict.cfg <code>/etc/default/grub.d/41_recovery_restrict.cfg</code>].

To re-enable the dracut emergency shell, which can be useful for debugging, see wiki chapter [[Recovery#Recovery_Mode|Recovery Mode]].

related forum discussion:

* https://forums.kicksecure.com/t/no-rescue-mode/1171

= Virtual Consoles =
An easier and more lightweight solution as alternative to [[#Recovery Mode|recovery mode]] might be [[Desktop#Virtual_Consoles|virtual consoles]]. If the graphical user interface is no longer starting, login to a virtual console might still be possible.

{{IconSet|h1|1}} Prerequisite knowledge: [[Desktop#Virtual Consoles|Virtual Consoles]].

{{IconSet|h1|2}} Try to log into a virtual console in a different, still functional VM (virtual machine) as an exercise.

{{IconSet|h1|3}} If that works, try to log into a virtual console in the broken VM.

{{IconSet|h1|4}} Done.

Virtual console access has been practiced on a working VM and attempted on the affected VM.

= Hard Drive Recovery =
Depends on the case, if

* {{IconSet|h2|A}} <u>No data needs recovery:</u> If no data needs to be recovered, a [[Factory Reset]] might be easier.
* {{IconSet|h2|B}} <u>Data recovery required:</u> See below.

{{IconSet|h1|1}} Choose unbootable host or {{VM}}.

{{Tab
|type=controller
|content=
{{Tab
|title= ==Unbootable Host Operating System==
|type=section
|image=
|addToClass=info-box
|active=
|content=
<u>If the host becomes unbootable</u> due to hard drive issues:

{{IconSet|h1|2}} Damage control: Stop using the hard drive. Further use might cause additional damage.

{{IconSet|h1|3}} Make a full 1:1 raw clone of the hard drive.

{{IconSet|h1|4}} Done.

Initial damage control has been performed and raw cloning has been initiated for the host drive.

{{IconSet|h1|5}} Revert.

If you want to return to normal operation, stop recovery actions and only resume using the original drive after recovery and diagnostics have been completed.
}}

{{Tab
|title= ==Unbootable VM==
|type=section
|image=
|addToClass=info-box
|active=
|content=
<u>If a VM becomes unbootable</u> due to hard drive issues:

{{IconSet|h1|2}} Damage control: Stop using the VM to prevent further damage.

{{IconSet|h1|3}} Make a clone of the VM and/or hard drive.

{{IconSet|h1|4}} Done.

Initial damage control has been performed and cloning has been initiated for the VM and/or its storage.

{{IconSet|h1|5}} Revert.

If you want to return to normal operation, stop recovery actions and resume the VM only after recovery and diagnostics have been completed.
}}
}}

{{IconSet|h1|2}} Data recovery: [[Unspecific]] to {{project_name_short}}.

Often, [[#Boot from External Drive|Boot from External Drive]] can help. This approach is useful because it bypasses the broken, non-booting operating system. Instead, you boot into a different, fully functional operating system, which can then be used to recover your data.

== Boot from External Drive ==
{{Anchor|Boot Virtual Machine from ISO instead of Virtual Hard Drive}}

This is useful for data recovery, [[Grow Virtual Harddisk]], [[Shrink Virtual Harddisk]], or installing a new operating system.

Which ISO to use? The [[ISO|{{project_name_short}} ISO]] should be suitable for these purposes.

{{Tab
|type=controller
|linkid=os-choice
|content=

{{Tab
|title= ===Host Operating System===
|type=section
|image=
|addToClass=info-box
|active=
|content=
<u>Note:</u> You need to burn a Kicksecure ISO on an external Flash or DVD before proceeding with the below steps.

{{IconSet|h1|1}} Insert the bootable Flash or DVD into your PC.

{{IconSet|h1|2}} Restart your computer if it's already on. If it's off, turn it on.

{{IconSet|h1|3}} During the boot process, a message will typically appear on the screen telling you to press a specific key to enter the BIOS/UEFI setup. Common keys are F2, F12, Delete, or Esc.

{{IconSet|h1|4}} Once inside the BIOS/UEFI, look for a section related to "Boot Order" or "Boot Priority" (use the keyboard to navigate).

{{IconSet|h1|5}} Set the Flash or DVD drive as the first boot device. This tells your computer to try booting from the Flash or DVD drive before any other devices.

{{IconSet|h1|6}} After setting the boot order, find the option to Save Changes and Exit. The exact wording might vary, but it’s typically something like "Save & Exit" or "Exit Saving Changes." Confirm your changes, and your PC will restart.

{{IconSet|h1|7}} If everything is set correctly, your PC should now boot from the Flash or DVD. You might see a message like "Press any key to boot from CD/DVD..." 
If you see this message, press any key on your keyboard to start booting from the DVD.

{{IconSet|h1|8}} Done.

Booting the system from the external Flash or DVD has been completed.

{{IconSet|h1|9}} Revert.

To return to normal booting, remove the external Flash or DVD and restore the internal drive as the first boot device in BIOS/UEFI.
}}

{{Tab
|title= ===VirtualBox===
|type=section
|image=[[File:Logo-virtualbox.png|25px]]
|addToClass=info-box
|active=
|content=
Booting a Debian-based VirtualBox VM (such as {{project_name_short}} or Whonix, which are derivatives based on Debian) using an ISO file instead of the internal disk involves changing the boot order and attaching the ISO file as a virtual CD/DVD drive.

Here are the steps to do this:

{{IconSet|h1|1}} Launch VirtualBox from your applications menu. In the VirtualBox Manager, click on the VM that you want to boot from an ISO, then click on the "Settings" button (a gear icon) at the top.

[[File:btext1.png|600px]]

{{IconSet|h1|2}} Configure Storage: In the Settings window, go to the "Storage" tab. You will see a tree structure with a controller (like IDE or SATA) and attached storage devices. Click on the CD/DVD drive icon with a "+" symbol attached to it.

[[File:btext2.png|470px]]

[[File:btext3.png|470px]]

{{IconSet|h1|3}} Add ISO File: On the top right corner of the window, you will see an icon of a CD/DVD. Click on this icon. Navigate to the location of your ISO file on your host machine. Select the ISO file, then press "Choose". The ISO file should now be attached to the VM as a virtual CD/DVD drive.

[[File:btext4.png|600px]]

[[File:btext5.png|600px]]

[[File:btext6.png|600px]]

{{IconSet|h1|4}} Configure Boot Order: Go to the "System" tab in the Settings window. Click on the "Motherboard" tab within the System settings. In the "Boot Order" section, ensure that "Optical" is checked and listed above "Hard Disk." You can reorder them by dragging or using the up/down arrows. Then click "OK" to save the settings.

[[File:btext7.png|470px]]

{{IconSet|h1|5}} Save and Start VM.

[[File:btext8.png|470px]]

[[File:btexd9.png|490px]]

{{IconSet|h1|6}} Complete Your Task.

* Proceed with your intended task (installation, recovery, etc.) using the booted ISO.
* Once you've finished and no longer need to boot from the ISO, shut down the VM.

{{IconSet|h1|7}} Detach ISO After Use: After the VM has been powered off, go back to the "Storage" tab in the VM settings. Click on the ISO file that you previously attached. Click on the CD/DVD icon on the right and choose "Remove disk from virtual drive."

[[File:btexd10.png|470px]]

{{IconSet|h1|8}} Revert Boot Order (if needed): Go to the "System" tab in the Settings window. Click on the "Motherboard" tab within the System settings. In the "Boot Order" section, ensure that "Hard Disk" is checked and listed above "Optical."

[[File:btexd11.png|470px]]

{{IconSet|h1|9}} Done.
VirtualBox has been configured to boot from the ISO and the task can be performed in the live environment.
{{IconSet|h1|10}} Revert.
The ISO has been detached and the boot order has been restored so the VM boots from the internal disk.
'''Troubleshooting:'''

* If the VM fails to boot from the ISO, ensure the ISO file is not corrupted and is compatible with your VM configuration.
}}
{{Tab
|title= ===KVM===
|type=section
|image=[[File:Logo-kvm.png|25px]]
|addToClass=info-box
|active=
|content=
<u>Note:</u> Kicksecure ISO downloaded in folder <code>/home/user/Downloads</code> on the host.

{{IconSet|h1|1}} Launch KVM (called Virtual Machine Manager) from your applications menu.

[[File:vmiso.png|400px]]

{{IconSet|h1|2}} Click on the VM that you want to boot from an ISO, then click on the "Open" button (Monitor icon) at the top.

[[File:vmiso2.png|600px]]

{{IconSet|h1|3}} Click on VM settings (bulb icon), then "SATA CDROM 1", and then "Browse" to choose the ISO.

[[File:vmiso3.png|600px]]

{{IconSet|h1|4}} "Downloads" represents the path /home/user/Downloads where the ISO is located. If you click on it and find it empty, then click on the refresh icon. Next, select the ISO and press "Choose Volume".

[[File:vmiso4.png|600px]]

{{IconSet|h1|5}} Make sure you have chosen the correct ISO, then click on "Apply".

[[File:vmiso4-1.jpg|600px]]

{{IconSet|h1|6}} Press on "Boot Options", then tick "Enable boot menu", Tick and move up "SATA CDROM 1," and finally, press "Apply".

[[File:vmiso5.png|600px]]

{{IconSet|h1|7}} Run the VM, and it should boot the Kicksecure ISO.

[[File:vmiso6.png|600px]]

[[File:vmiso7.png|600px]]

{{IconSet|h1|8}} Done.

The KVM VM has been booted using the ISO and is ready for recovery tasks.

{{IconSet|h1|9}} Revert.

To boot from the original operating system again, undo the ISO attachment and restore the previous boot options.
}}

{{Tab
|title= ===Qubes===
|type=section
|image=[[File:Logo-qubes.png|25px]]
|addToClass=info-box
|active=
|content=
<u>Note:</u> You need to download the {{project_name_short}} ISO into a separate AppVM/Qube that will be used to boot {{project_name_short}} from (in the example below, the ISO has been downloaded in "debian-personal").

{{IconSet|h1|1}} Launch "Qube Manager," click on the VM that you want to boot the ISO on (Kali-Linux StandaloneVM will be used as an example), then click on the "Qube Settings" button (a gear icon) at the top.

[[File:qubesbootiso1.png|800px]]

{{IconSet|h1|2}} Click on "Advanced" then "Boot qube from CD-ROM"

[[File:qubesbootiso2.png|600px]]

{{IconSet|h1|3}} Choose "from file in qube" then select your AppVM where you downloaded the ISO ("debian-personal" is used here) then Press "..." to choose the path of the downloaded ISO.

[[File:qubesbootiso3.png|600px]]

{{IconSet|h1|4}} Choose the downloaded ISO from the AppVM path where you have downloaded it.

[[File:qubesbootiso4.png|600px]]

{{IconSet|h1|5}} Make sure everything is as it should be, then press "OK".

[[File:qubesbootiso5.png|600px]]

{{IconSet|h1|6}} {{project_name_short}} ISO should boot perfectly.

[[File:qubesbootiso6.png|600px]]

[[File:qubesbootiso7.png|600px]]

{{IconSet|h1|7}} If you shut down {{project_name_short}} live mode and reopen the VM, the ISO will be detached automatically, and the VM will boot the installed/default operating system.

{{IconSet|h1|8}} Done.

Booting the Qubes VM from the selected ISO has been completed.

{{IconSet|h1|9}} Revert.

To return to the installed system immediately, shut down the live session and restart the VM so it boots from the default disk.
}}
}}

= Chroot =

If an error occurs that prevents {{project_name_short}} from booting, it is possible to [https://www.computerhope.com/unix/chroot.htm chroot] into {{project_name_short}} from a live CD to fix the problem.

A bootable disk image must be downloaded for this purpose -- Kicksecure's [[ISO]] may be used for this purpose by booting the ISO into <code>LIVE Mode | UNRESTRICTED Session | system recovery, install</code>. [https://www.debian.org/CD/live/ Debian Live images] or the [https://www.archlinux.org/download/ Arch ISO] are also useful options for this procedure.

Use the [[Recovery#Boot_from_External_Drive|Boot from External Drive]] instructions above to boot the VM or physical machine from the chosen disk image. After booting into the Live CD, follow these steps.

{{Box|text=
{{IconSet|h1|1}} List the available drives and partitions.

{{CodeSelect|code=
fdisk -l
}}

{{IconSet|h1|2}} Mount the partition.

{{CodeSelect|code=
mount /dev/sda1 /mnt
}}

Replace "/dev/sda1" with the drive partition name.

{{IconSet|h1|3}} Chroot into the partition.

{{CodeSelect|code=
chroot /mnt /bin/bash
}}

{{IconSet|h1|4}} ''Optional:'' If the PATH variable is incorrect, it can be fixed with the following command.

{{CodeSelect|code=
source /etc/profile
}}

{{IconSet|h1|5}} Done.

The target partition has been mounted and a chroot shell has been opened.

{{IconSet|h1|6}} Revert.

Exit the chroot using <code>exit</code> and unmount the partition when finished.
}}

= Serial Console =
{{IconSet|h1|1}} Host preparation.

Install <code>socat</code> on the host operating system. The following steps apply to Linux distributions.

{{Install Package|package=
socat
}}

{{IconSet|h1|2}} VM preparation.

Inside the {{project_name_short}} virtual machine where you want to enable the serial console, install the <code>serial-console-enable</code> package.

{{Install Package|package=
serial-console-enable
}}

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Installing <code>serial-console-enable</code> will cause the default GRUB bootloader theme to vanish. A text-only bootloader screen will be displayed instead. This happens because <code>serial-console-enable</code> disables <code>gfxterm</code> in GRUB's configuration. This is normal.
}}

Installed by default would be nice but it is not installed by default due to an issue. Namely, [https://forums.whonix.org/t/serial-console-in-virtualbox/8021/13 when enabling a serial console while none is connected, the systemd journal gets spammed with errors.]

{{IconSet|h1|3}} Platform specific.

Choose host operating system, VirtualBox or KVM.

{{Tab
|type=controller
|content=
{{Tab
|title= == Host Operating System ==
|image=[[File:Gnu_operating_system.png|40px]]
|addToClass=info-box
|active=true
|content=
[[Undocumented]]. It is advised to research these using a non-{{project_name_short}} VM such as Debian <code>{{Stable project version based on Debian codename}}</code> and [[unspecific|learn it in a generic way]] which could then also be applied to {{project_name_short}}.

}} <!-- close tab: Host Operating System -->

{{Tab
|title= == VirtualBox ==
|image=[[File:Logo-virtualbox.png|25px]]
|addToClass=info-box
|content=
{{Tab
|type=controller
|content=
{{Tab
|title= === Read Only Serial Console ===
|image=
|addToClass=info-box
|active=true
|content=
This option is very useful for capturing diagnostic output from a virtual machine. It allows a log of everything written to the kernel console to be obtained -- all console output is written to a plain text file from boot until shutdown. The logfile persists after VM shutdown, but is overwritten after the VM is shutdown and powered on again.

{{Box|text=
{{IconSet|h1|1}} Enable the serial ports option.

<code>{{project_name_short}} VM settings</code> &rarr; <code>Serial Ports</code> &rarr; <code>Tick enable</code>

Configure the following settings:
* <u>Port Number</u>: <code>COM1</code> (default)
* <u>Port Mode</u>: <code>Raw File</code>
* <u>Path/Address</u>: <code>/home/user/vbox-raw-file</code>

{{IconSet|h1|2}} View the file with a text editor.

Any text editor can be used for this purpose. For example to view the file with Featherpad, run.

{{CodeSelect|code=
featherpad /home/user/vbox-raw-file
}}

{{IconSet|h1|3}} ''Optional:'' View the file as it is being appended to from a terminal emulator.

The logfile is also compatible with other standard Linux utilities such as <code>tail</code>. To view it as it is being written, run.

{{CodeSelect|code=
tail -f /home/user/vbox-raw-file
}}

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    =
'''Warning:''' If the guest may be compromised, do NOT follow these steps by using <code>cat</code>, <code>tail</code>, or similar utilities to dump the contents of the serial console file to the terminal! The file can contain arbitrary ANSI sequences written by the guest, which may exploit security vulnerabilities in the host's terminal emulator and allow a VM escape.
}}

{{IconSet|h1|4}} Retain the file contents.

After VM shutdown it may be useful to retain its contents by copying the <code>vbox-raw-file</code> elsewhere to make it a persistent log file. If this is desirable, run.

{{CodeSelect|code=
cp /home/user/vbox-raw-file /home/user/vbox-console-log
}}

{{IconSet|h1|5}} Done.

A read-only serial console log has been enabled and can be viewed or retained as needed.

{{IconSet|h1|6}} Revert.

Disable the serial port again or change its mode if serial logging is no longer required.
}}

}} <!-- close tab: Read Only Serial Console -->

{{Tab
|title= === Interactive Serial Console ===
|image=
|addToClass=info-box
|content=
This procedure does not yet work during the grub boot menu.

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    =
'''Warning:''' If the guest may be compromised, do NOT follow this procedure! The guest will be able to write arbitrary ANSI sequences to the host's terminal emulator, which may exploit security vulnerabilities in the terminal and allow a VM escape.
}}

{{Box|text=
{{IconSet|h1|1}} Enable serial ports on the host.

<code>{{project_name_short}} VM settings</code> &rarr; <code>Serial Ports</code> &rarr; <code>Tick enable</code>

Configure the following settings:

* <u>Port Number</u>: <code>COM1</code> (default)
* <u>Port Mode</u>: <code>Host Pipe</code>
* <u>Option</u>: '''un'''check <code>Connect to existing pipe/socket</code>
* <u>Path/Address</u>: <code>/home/user/vbox-socket-file</code>

<ref>
If an error like the following appears.

<pre>
Failed to open a session for the virtual machine Kicksecure-LXQt_18.0.0.4.9.
</pre>

<pre>
NamedPipe#0 failed to connect to local socket /home/user/vbox-socket-file (VERR_FILE_NOT_FOUND).
</pre>

<pre>
Result Code: NS_ERROR_FAILURE (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</pre>

Then you must <u>un</u>check <code>Connect to existing pipe/socket</code>.
</ref> <ref>
{{CodeSelect|code=
vboxmanage modifyvm {{project_name_short}}-LXQt --uart1 0x3F8 4 --uartmode1=server /home/user/vbox-socket-file
}}
</ref>

{{IconSet|h1|2}} Connect to the relevant unix domain socket file.

On the host, run the following socat command to connect to the unix domain socket file which is connected to the operating system running inside the virtual machine. <ref>
{{CodeSelect|code=
socat - UNIX-CONNECT:/home/user/vbox-socket-file
}}
</ref>

{{CodeSelect|code=
socat - UNIX-CONNECT:/home/user/vbox-socket-file
}}

Depending on when the above command is run, nothing might appear. The reason is an interactive serial console will only show messages once connected to the serial console; old messages cannot be viewed that way. If the above command is run during early boot, then verbose messages will appear during boot. However, if you press <code>Enter</code> that should result in the virtual console asking for authentication.

{{IconSet|h1|3}} Log in to the {{project_name_short}} session.

Press <code>Enter</code>. The following prompt will appear.

<pre>
host login:
</pre>

Do not enter your host login username! Enter your {{project_name_short}} user login name, which is most likely <code>user</code>. Press <code>Enter</code>. The following prompt will appear.

<pre>
Password:
</pre>

Enter the password for that user account; see [[Default Passwords]]. Press <code>Enter</code>.

<u>Warning</u>: the password will not be hidden by asterisk ("<code>*</code>") symbols. In other words, the password will be written in cleartext and could be read by anyone looking over your shoulder.

<u>Note:</u> [[Root|root logins]] are not possible by default.

{{IconSet|h1|4}} Done.

Interactive serial console access has been configured and connected.

{{IconSet|h1|5}} Revert.

Disable the serial port again or remove the host pipe configuration if interactive console access is no longer required.
}}

Forum discussion: https://forums.whonix.org/t/serial-console-in-virtualbox/8021

}} <!-- close tab: Interactive Serial Console -->

}} <!-- close Controller: Virtualbox read only and interactive -->

}} <!-- close tab: Virtualbox -->

{{Tab
|title= == KVM ==
|image=[[File:Logo-kvm.png|25px]]
|addToClass=info-box
|content=
See [[KVM]], [[KVM#Command_Line_Interface_.28CLI.29|serial console]].

Wiki TODO: documentation needs to be ported here from https://www.whonix.org/wiki/KVM#Command_Line_Interface_.28CLI.29

}} <!-- close tab: KVM -->

{{Tab
|title= == Qubes ==
|image=[[File:Logo-qubes.png|25px]]
|addToClass=info-box
|content=
This procedure is [[undocumented]] and unspecific to {{project_name_short}}. See [[unspecific]].

}} <!-- close tab: Qubes -->

}} <!-- close Controller: All Tabs -->

= Kicksecure specific =
Enable the [[Recovery#Serial_Console|Serial Console]].

Write to serial console by writing to the appropriate serial console device. <ref>
To find the serial console.

{{CodeSelect|code=
dmesg | grep serial
}}

(nothing helpful)

{{CodeSelect|code=
dmesg | grep tty
}}

Found <code>/dev/ttyS0</code>.

Test write.

{{CodeSelect|code=
echo test > /dev/ttyS0
}}
</ref>

Write <code>dmesg</code> to serial console.

{{CodeSelect|code=
dmesg > /dev/ttyS0
}}

= Qubes specific =
== Non-Bootable Qubes VM ==
This is [[unspecific|unspecific to {{project_name_short}}]]. Therefore the primary contact of support must be the Qubes community, not {{project_name_short}}.

Always have a full, tested (can be restored) backup first before proceeding. A lot of the following ideas are [[undocumented]].

Ideas:

* {{IconSet|h1|A}} Set the broken VM's NetVM setting to "none" (optional), change to a different Template (perhaps a re-installed Template).
* {{IconSet|h1|B}} Can a Qubes VM be booted from a virtual ISO? (Such as for example the Kicksecure [[ISO]]?
* {{IconSet|h1|C}} Can a Qubes VM be booted into recovery mode?
* {{IconSet|h1|D}} Show full console window ("desktop") of Qubes VM by using Qubes "debug mode"?
* {{IconSet|h1|E}} Can Qubes boot from a different VM, assign the other VMs virtual hard drive, mount it, make changes to fix it, unmount it, assign back to original VM and boot it? -> https://www.qubes-os.org/doc/mount-lvm-image/
* {{IconSet|h1|F}} If the Qubes <code>/rw/rc.local</code> mechanism is broken inside the VM:
** Boot the Template, disable Qubes' mechanism to process <code>/rw/rc.local</code>.
** As a hack, an early running systemd unit configured in the Template could delete <code>/rw/rc.local</code> at VM startup before Qubes processes it.

= Unlock User Account: Excessive Wrong Password Entry Attempts =

See: [[Root#Unlock_User_Account:_Excessive_Wrong_Password_Entry_Attempts|Unlock User Account: Excessive Wrong Password Entry Attempts]].

= Reset User Account Password =
See [[Root#Reset_User_Account_Password|Reset User Account Password]].

= See Also =
* [[SysRq|System Recovery using SysRq Key]]
* [[debug-misc]]
* [[systemcheck]]
* [[Factory Reset]]
* [[Broken Boot]]

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]