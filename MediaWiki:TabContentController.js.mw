/*
TabContentController Gadget - JS Initialisation, Setup, Events
See detailed documentation in Dev/mediawiki
deferrable:YES -- This is a standalone gadget / augmentation
*/

/* See Dev/mediawiki for documentation */

(function() {
	
	// as jQuery extension
	
	$.fn.tabContentController = function(action) {
		
		// Only allow 'init' at the moment (extendable later)
		if( action != 'init' ) return;
		
		$(this).each( function() {
			// Prevent double initialization
			if( $(this).hasClass('js-fully-loaded') ) return;
			
			// Only elements with this attribute and class are accepted, but not the controller wrapper itself
			if( ! $(this).attr('data-tcc-id') || ! $(this).hasClass('tab-content-controller') ) return;
			
			// Setup

			let tc = $(this);
			tc.append( '<div class="mininav"><ul></ul></div><div class="content"></div>' );
			
			tc.children('.content').append( $('[data-tcc-id=' + tc.attr('data-tcc-id') + ']:not(.tab-content-controller') );
			
			let tablist = tc.find('.mininav > ul');
			
			if( tc.hasClass('tcc-dark') ) tc.children('.mininav').addClass('mn-dark');
			
			function chooseTab( tab ) {
				tablist.find('li > *').removeClass('active');
				tab.children().addClass('active');
				tc.children('.content').children().removeClass('active');
				tc.children('.content').children(`[data-tcc-contentId="${tab.attr('data-tcc-contentId')}"]`).addClass('active')
				console.log( tab );
			}
			
			tc.children('.content').children().each( function() {
				let content = $(this);
				let tab = $( '<li><span></span></li>' );
				if( content.attr('data-tcc-url') ) tab = $( `<li class="is-link"><a href="${content.attr('data-tcc-url')}"></a></li>` );
				let contentId = 'id-' + Math.random().toString().substr(2);
				tab.attr( 'data-tcc-contentId', contentId );
				content.attr( 'data-tcc-contentId', contentId );
				tablist.append( tab );
				tab.children().eq(0).text( content.attr('data-tcc-title') );
				if( content.hasClass('active') ) tab.children().addClass('active');
				if( content.attr('data-tcc-image') ) tab.children().prepend( '<img class="pos-1px-up" src="' + content.attr('data-tcc-image') + '">');
				
				// Event : Click
				if( ! content.attr('data-tcc-url') ) tab.on( 'click', () => chooseTab( tab ) );
			});
			
			// If no element is active make the first one active that is not a link
			if( ! tc.children('.content').children().hasClass('active') ) chooseTab( tablist.find('li:not(.is-link)').eq(0) );
			
			tc.addClass('js-fully-loaded');
		});
		
	};
	
	// Automatic initialization
	
	$('.tab-content-controller[data-tcc-id]').tabContentController('init');
	
})();



/*
[[Category:MultiWiki]]
*/